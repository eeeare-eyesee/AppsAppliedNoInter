USE LTMPROD
GO

SELECT DISTINCT Cand.CANDIDATE AS CandidateID
	,LTRIM(RTRIM(Cand.PRESENTATIONNAMESNAPSHOT)) AS [Candidate Name]
	,CASE 
		WHEN Cand.TYPE = 1	THEN 'Internal'
		WHEN Cand.TYPE = 2	THEN 'External'
		END AS CandidateType
	,LTRIM(RTRIM(JR.WORKSCHEDULE)) AS [Work Schedule]
	,LTRIM(RTRIM(JA.WORKTYPE)) AS [Work Type]
	,JR.JOBREQUISITION AS JobReq#
	,LTRIM(RTRIM(Recruiter.PRESENTATIONNAMESNAPSHOT)) AS [Recruiter]
	,LTRIM(RTRIM(POS.DESCRIPTION)) AS [Position Description]
	,JR.FTE AS FTE
	,SUBSTRING(HROU.DESCRIPTION, 1, 2) AS PL
	,SUBSTRING(HROU.DESCRIPTION, 3, 4) AS Dept
	,SUBSTRING(HROU.DESCRIPTION, 8, LEN(HROU.DESCRIPTION)) AS Department
	,CASE 
		WHEN JA.STATUS = 1	THEN 'InProgress'
		WHEN JA.STATUS = 2	THEN 'Attached'
		WHEN JA.STATUS = 3	THEN 'Applied'
		WHEN JA.STATUS = 4	THEN 'Withdrawn'
		WHEN JA.STATUS = 5	THEN 'Closed'
		END AS JobAppStatus
	,CASE 
		WHEN JR.STATUS = 1	THEN 'Pending'
		WHEN JR.STATUS = 2	THEN 'Open'
		WHEN JR.STATUS = 3	THEN 'OnHold'
		WHEN JR.STATUS = 4	THEN 'Cancelled'
		WHEN JR.STATUS = 5	THEN 'Filled'
		WHEN JR.STATUS = 6	THEN 'Closed'
		WHEN JR.STATUS = 7	THEN 'Draft'
		WHEN JR.STATUS = 8	THEN 'ApprovalRequested'
		END AS JobReqStatus
	,CASE 
		WHEN JA.SELECTIONPROCESS = 0	THEN 'Blank'
		WHEN JA.SELECTIONPROCESS = 2	THEN 'NewApplication'
		WHEN JA.SELECTIONPROCESS = 3	THEN 'ScreenOutOnline'
		WHEN JA.SELECTIONPROCESS = 4	THEN 'CandidateScreened'
		WHEN JA.SELECTIONPROCESS = 5	THEN 'HiringManagerReview'
		WHEN JA.SELECTIONPROCESS = 6	THEN 'Interview'
		WHEN JA.SELECTIONPROCESS = 7	THEN 'Offer'
		WHEN JA.SELECTIONPROCESS = 8	THEN 'OnBoard'
		WHEN JA.SELECTIONPROCESS = 9	THEN 'Hire'
		WHEN JA.SELECTIONPROCESS = 10	THEN 'Disposition'
		END AS SelectionProcess
	,CASE 
		WHEN JR.BUDGETED = 0	THEN 'No'
		WHEN JR.BUDGETED = 1	THEN 'Yes'
		END AS ReqBudgeted
	,LTRIM(RTRIM(JR.REASONFOROPENING)) AS [Reason for Opening]
	,convert(VARCHAR(10), JA.APPLICATIONDATE, 101) AS [Application Date]
	,convert(VARCHAR(10), JR.OPENDATE, 101) AS [Open Date]
	,convert(VARCHAR(10), JA.OFFERDATE, 101) AS [Offer Date]
	,CASE 
		WHEN JA.ACCEPTANCEDATE = '1753-01-01'	THEN convert(VARCHAR(10), JR.FILLEDDATE, 101)
		ELSE convert(VARCHAR(10), JA.ACCEPTANCEDATE, 101)
		END AS [Accept/Fill Date]
	,convert(VARCHAR(10), JA.EMPLOYMENTSTARTDATE, 101) AS [Employment Start Date]
	,LTRIM(RTRIM(Cand.PCIEMAILADDRESS)) AS [Email Address]
	,Cand.PCITNSUBSCRIBERNUMBER AS HomePhone
	,Cand.PCIMPMPNSUBSCRIBERNUMBER AS MobileNumber
	,LTRIM(RTRIM(CDR.DESCRIPTION)) AS [Candidate Disposition Reason]

FROM hcm.JOBAPPLICATION AS JA(NOLOCK)

LEFT OUTER JOIN hcm.JOBREQUISITION AS JR (NOLOCK)
	ON JA.JOBREQUISITION = JR.JOBREQUISITION

LEFT OUTER JOIN hcm.POSITION AS POS(NOLOCK)
	ON JR.POSITION = POS.POSITION

LEFT OUTER JOIN hcm.EMPLOYEE AS Recruiter(NOLOCK)
	ON JR.RECRUITER = Recruiter.EMPLOYEE

LEFT OUTER JOIN hcm.HRORGANIZATIONUNIT AS HROU(NOLOCK)
	ON JR.HRORGANIZATIONUNIT = HROU.HRORGANIZATIONUNIT

LEFT OUTER JOIN hcm.CANDIDATEDISPOSITIONREASON AS CDR(NOLOCK)
	ON JA.CANDIDATEDISPOSITIONREASON = CDR.CANDIDATEDISPOSITIONREASON

LEFT OUTER JOIN hcm.CANDIDATE AS Cand(NOLOCK)
	ON JA.CANDIDATE = Cand.CANDIDATE

LEFT OUTER JOIN hcm.JOB AS Job(NOLOCK)
	ON POS.JOB = Job.JOB

WHERE 1=1 
	AND Recruiter.EMPLOYEE NOT IN (
		20098.00
		,33409.00
		,34762.00
		,38322.00
		,41631.00
		,43273.00
		,44322.00
		,6129.00
		,45875.00
		,32014.00
		)
	AND JA.APPLICATIONDATE > DATEADD(yy, DATEDIFF(yy, 0, GETDATE()), 0)
	AND JA.STATUS IN (
		3
		,5
		)
	AND NOT EXISTS (
		SELECT DISTINCT can.CANDIDATE AS Candidate
		--Cand.PRESENTATIONNAMESNAPSHOT as CandidateName,
		--case	when Cand.TYPE=1 then 'Internal'
		--		when Cand.TYPE=2 then 'External'
		--end as CandidateType,
		--JobReq.JOBREQUISITION as JobReq,
		--Recruit_EE.PRESENTATIONNAMESNAPSHOT as Recruiter,
		--Pos.DESCRIPTION as PositionDescription,
		--SUBSTRING(HROrg.DESCRIPTION,1,2) as PL,
		--SUBSTRING(HROrg.DESCRIPTION,3,4) as Dept,
		--SUBSTRING(HROrg.DESCRIPTION, 8, LEN(HROrg.DESCRIPTION)) as Department,
		--InterviewType.DESCRIPTION as InterviewType,
		--convert(varchar(10),JobAppInt.INTERVIEWDATE,101) as InterviewDate,
		--HireMgr_EE.PRESENTATIONNAMESNAPSHOT as HiringManager,
		--Interviewer_EE.PRESENTATIONNAMESNAPSHOT as Interviewer,
		--Cand.PCIEMAILADDRESS as Email,
		--Cand.PCITNSUBSCRIBERNUMBER as HomeNumber,
		--Cand.PCIMPMPNSUBSCRIBERNUMBER as MobileNumber
		FROM hcm.JOBAPPINTERVIEW AS JobAppInt(NOLOCK)
		LEFT OUTER JOIN hcm.INTERVIEWTYPE AS InterviewType (NOLOCK)
			ON JobAppInt.INTERVIEWTYPE = InterviewType.INTERVIEWTYPE
		LEFT OUTER JOIN hcm.JOBAPPLICATION AS JobApp(NOLOCK)
			ON JobAppInt.JOBREQUISITION = JobApp.JOBREQUISITION
				AND JobAppInt.JOBAPPLICATION = JobApp.JOBAPPLICATION
				AND JobAppInt.CANDIDATE = JobApp.CANDIDATE
		LEFT OUTER JOIN hcm.JOBREQUISITION AS JobReq(NOLOCK)
			ON JobAppInt.JOBREQUISITION = JobReq.JOBREQUISITION
		LEFT OUTER JOIN hcm.EMPLOYEE AS Interviewer_EE(NOLOCK)
			ON JobAppInt.INTERVIEWER = Interviewer_EE.EMPLOYEE
		LEFT OUTER JOIN hcm.POSITION AS Pos(NOLOCK)
			ON JobReq.POSITION = Pos.POSITION
		LEFT OUTER JOIN hcm.HRORGANIZATIONUNIT AS HROrg(NOLOCK)
			ON JobReq.HRORGANIZATIONUNIT = HROrg.HRORGANIZATIONUNIT
		LEFT OUTER JOIN hcm.EMPLOYEE AS Recruit_EE(NOLOCK)
			ON JobReq.RECRUITER = Recruit_EE.EMPLOYEE
		LEFT OUTER JOIN hcm.EMPLOYEE AS HireMgr_EE(NOLOCK)
			ON JobReq.HIRINGMANAGER = HireMgr_EE.EMPLOYEE
		LEFT OUTER JOIN hcm.CANDIDATE AS can(NOLOCK)
			ON JobApp.CANDIDATE = Cand.CANDIDATE
		WHERE Recruit_EE.EMPLOYEE NOT IN (
				20098.00
				,33409.00
				,34762.00
				,38322.00
				,41631.00
				,43273.00
				,44322.00
				,6129.00
				,45875.00
				,32014.00
				)
			AND JobAppInt.DELETEFLAG = 0x00000000000000000000000000000000
			AND JobAppInt.INTERVIEWDATE > DATEADD(yy, DATEDIFF(yy, 0, GETDATE()), 0)
			AND can.CANDIDATE = Cand.CANDIDATE
		)
	AND NOT EXISTS (
		SELECT DISTINCT
			--LTRIM(RTRIM(Recruit_EE.PRESENTATIONNAMESNAPSHOT)) as Recruiter,
			--JobReq.JOBREQUISITION JobReq#,
			--Job.JOB as JobCode,
			--LTRIM(RTRIM(Pos.DESCRIPTION)) as [Position Description],
			--JobReq.FTE,
			--LTRIM(RTRIM(JobReq.WORKSCHEDULE)) as [Work Schedule],
			--JobReq.REASONFOROPENING as [Reason for Opening],
			--SUBSTRING(HROrgUnit.DESCRIPTION,1,2) as PL,
			--SUBSTRING(HROrgUnit.DESCRIPTION,3,4) as Dept,
			--SUBSTRING(HROrgUnit.DESCRIPTION, 8, LEN(HROrgUnit.DESCRIPTION)) as Department,
			--LTRIM(RTRIM(Mgr_EE.PRESENTATIONNAMESNAPSHOT)) as Manager,
			--convert(varchar(10),JobReq.OPENDATE,101) as [Open Date],
			--case when JobApp.ACCEPTANCEDATE = '1753-01-01' then convert(varchar(10),JobReq.FILLEDDATE,101) 
			--else convert(varchar(10),JobApp.ACCEPTANCEDATE,101) end as [Accept/Fill Date],
			--convert(varchar(10),JobReq.FILLEDDATE,101) as [Filled Date],
			--convert(varchar(10),JobApp.EMPLOYMENTSTARTDATE,101) as [Start Date],
			Can.CANDIDATE AS Candidate#
		--LTRIM(RTRIM(Cand.PRESENTATIONNAMESNAPSHOT)) as [Candidate Name],
		--case	when Cand.TYPE=1 then 'Internal'
		--		when Cand.TYPE=2 then 'External'
		--end as CandidateType,
		--CandAHSN.ALPHA as [Candidate AHSN],
		--LTRIM(RTRIM(Cand.PCIEMAILADDRESS)) as [Email Address],
		--LTRIM(RTRIM(Cand.PCITNSUBSCRIBERNUMBER)) as [Home Phone],
		--Cand.PCIMPMPNSUBSCRIBERNUMBER as [Mobile Number],
		--LTRIM(RTRIM(Cand.PCIPADAADDRESSLINE1)) as [Address Line 1],
		--LTRIM(RTRIM(Cand.PCIPADAADDRESSLINE2)) as [Address Line 2],
		--LTRIM(RTRIM(Cand.PCIPAMUNICIPALITY)) as [City],
		--Cand.PCIPASTATEPROVINCE as State,
		--Cand.PCIPAPOSTALCODE as Zip
		FROM hcm.JOBREQUISITION AS JobReq(NOLOCK)
		LEFT OUTER JOIN hcm.JOBAPPLICATION AS JobApp
			ON JobReq.JOBREQUISITION = JobApp.JOBREQUISITION
		LEFT OUTER JOIN hcm.EMPLOYEE AS Mgr_EE(NOLOCK)
			ON JobReq.HIRINGMANAGER = Mgr_EE.EMPLOYEE
		LEFT OUTER JOIN hcm.EMPLOYEE AS Recruit_EE(NOLOCK)
			ON JobReq.RECRUITER = Recruit_EE.EMPLOYEE
		LEFT OUTER JOIN hcm.HRORGANIZATIONUNIT AS HROrgUnit(NOLOCK)
			ON JobReq.HRORGANIZATIONUNIT = HROrgUnit.HRORGANIZATIONUNIT
		LEFT OUTER JOIN hcm.POSITION AS Pos(NOLOCK)
			ON JobReq.POSITION = Pos.POSITION
		LEFT OUTER JOIN hcm.CANDIDATE AS Can(NOLOCK)
			ON JobApp.CANDIDATE = Cand.CANDIDATE
		LEFT OUTER JOIN hcm.USERFIELD_STORAGE AS CandAHSN(NOLOCK)
			ON Cand.UNIQUEID = CandAHSN.UFSUNIQUEID
				AND CandAHSN.UFSFIELDNAME = 'NortonCandidateAHSN'
		LEFT OUTER JOIN hcm.JOB AS Job(NOLOCK)
			ON Pos.JOB = Job.JOB
		WHERE Recruit_EE.EMPLOYEE NOT IN (
				20098.00
				,33409.00
				,34762.00
				,38322.00
				,41631.00
				,43273.00
				,44322.00
				,6129.00
				,45875.00
				,32014.00
				)
			--and JobReq.REASONFOROPENING <> 'EXTERNPROGRAM'
			--and JobReq.REASONFOROPENING <> 'ACQUISITION'
			AND JobApp.STATUS NOT IN (
				1
				,4
				)
			AND JobReq.STATUS IN (
				5
				,6
				)
			AND JobApp.SELECTIONPROCESS IN (
				7
				,8
				,9
				)
			--and HROrgUnit.DESCRIPTION not like '%Norton Clinical Agency-Srvcs%'
			--and HROrgUnit.DESCRIPTION not like '%Acquisition Hire Tracking%'
			--and Pos.DESCRIPTION not like '%National Nursing Trainee'
			--and Pos.DESCRIPTION not like '%Nurse Extern%'
			--and Pos.DESCRIPTION not like '%Nurse Explorer%'
			AND CASE 
				WHEN JobApp.ACCEPTANCEDATE = '1753-01-01'
					THEN convert(VARCHAR(10), JobReq.FILLEDDATE, 101)
				ELSE convert(VARCHAR(10), JobApp.ACCEPTANCEDATE, 101)
				END > DATEADD(yy, DATEDIFF(yy, 0, GETDATE()), 0)
			AND Cand.CANDIDATE = Can.CANDIDATE
		)
ORDER BY Cand.CANDIDATE ASC
